/*!
 * AKARI-Markdown.js v1.0.0
 * (c) 2026 h-o-w-a-r-d
 * Released under the MIT License.
 * Repository: https://github.com/h-o-w-a-r-d/AKARI-Markdown.js
 * Documentation: https://h-o-w-a-r-d.github.io/AKARI-Markdown.js/README.md
 */import{marked as a}from"https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.esm.js";import l from"https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.es.min.js";import m from"https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.mjs";import h from"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/es/highlight.min.js";import c from"https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.esm.min.mjs";const d={katex:"https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css",highlight:"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css"};export class AkariMarkdown{constructor(i,e={}){if(this.container=typeof i=="string"?document.querySelector(i):i,!this.container)throw new Error(`[AkariMarkdown] \u627E\u4E0D\u5230\u76EE\u6A19\u5143\u7D20: ${i}`);this.options={theme:"default",securityLevel:"loose",throttleInterval:50,mermaidDebounce:500,hooks:{},...e},this.counter=0,this.mathMap=new Map,this.codeMap=new Map,this._renderTimer=null,this._mermaidTimer=null,this._latestMarkdown="",this._isRendering=!1,this._injectStyles(),this._initLibraries()}static async renderElements(i,e={}){const t=document.querySelectorAll(i),r=Array.from(t).map(async s=>{let n=s.getAttribute("data-markdown")||s.textContent;await new AkariMarkdown(s,e).render(n.trim()),s.style.display="block"});await Promise.all(r)}async render(i,e=!1){if(this._latestMarkdown=i,e){this._clearTimers(),await this._performRender();return}this._isRendering||this._renderTimer||(this._renderTimer=setTimeout(async()=>{this._isRendering=!0,await this._performRender(),this._isRendering=!1,this._renderTimer=null},this.options.throttleInterval))}async _performRender(){let i=this._latestMarkdown||"";this.options.hooks.beforeParse&&(i=this.options.hooks.beforeParse(i)),this.mathMap.clear(),this.codeMap.clear(),this.counter=0;let e=this._protectCodeAndMath(i),t="";try{t=a.parse(e)}catch(r){console.error("[AkariMarkdown] Parse error:",r),t='<p style="color:red">Markdown Parse Error</p>'}t=l.sanitize(t,{ADD_TAGS:["iframe"],ADD_ATTR:["target","class"]}),this.options.hooks.afterSanitize&&(t=this.options.hooks.afterSanitize(t)),t=this._restoreAndRenderMath(t),this.container.innerHTML=t,this._scheduleMermaidRender(),this.options.hooks.onRendered&&this.options.hooks.onRendered(this.container)}_scheduleMermaidRender(){this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._mermaidTimer=setTimeout(async()=>{const i=this.container.querySelectorAll(".mermaid");if(i.length!==0)try{await c.run({nodes:i,suppressErrors:!0})}catch{}},this.options.mermaidDebounce)}_clearTimers(){this._renderTimer&&clearTimeout(this._renderTimer),this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._renderTimer=null,this._mermaidTimer=null}_injectStyles(){const i=(e,t)=>{if(!document.querySelector(`link[href="${e}"]`)){const r=document.createElement("link");r.rel="stylesheet",r.href=e,r.dataset.dependency=t,document.head.appendChild(r)}};i(d.katex,"katex-css"),i(d.highlight,"highlight-css")}_initLibraries(){c.initialize({startOnLoad:!1,theme:this.options.theme,securityLevel:this.options.securityLevel});const i=new a.Renderer;i.code=({text:e,lang:t})=>{if(t==="mermaid")return`<div class="mermaid">${e}</div>`;if(t&&h.getLanguage(t))try{return`<pre><code class="hljs language-${t}">${h.highlight(e,{language:t}).value}</code></pre>`}catch{}return`<pre><code class="hljs">${e}</code></pre>`},a.use({renderer:i})}_protectCodeAndMath(i){let e=i;return e=e.replace(/(\n|^)```[\s\S]*?```/g,t=>{const r=`CODEBLOCK${this.counter++}ENDCODE`;return this.codeMap.set(r,t),r}),e=e.replace(/(`+)(.*?)\1/g,t=>{const r=`CODEINLINE${this.counter++}ENDCODE`;return this.codeMap.set(r,t),r}),e=e.replace(/\\\$/g,t=>{const r=`ESCAPEDDOLLAR${this.counter++}END`;return this.codeMap.set(r,t),r}),e=e.replace(/(^|\n)\$\$([\s\S]+?)\$\$($|\n)/g,(t,r,s,n)=>{const o=`MATHBLOCK${this.counter++}ENDMATH`;return this.mathMap.set(o,{tex:s,display:!0}),r+o+n}),e=e.replace(/\$([^\n]+?)\$/g,(t,r)=>{if(/[\u4e00-\u9fa5]/.test(r)&&!r.includes("\\text"))return t;const s=`MATHINLINE${this.counter++}ENDMATH`;return this.mathMap.set(s,{tex:r,display:!1}),s}),this.codeMap.forEach((t,r)=>e=e.replace(r,t)),e}_restoreAndRenderMath(i){let e=i;return this.mathMap.forEach((t,r)=>{try{const s=m.renderToString(t.tex,{displayMode:t.display,throwOnError:!1,output:"html"});e=e.split(r).join(s)}catch{e=e.split(r).join(t.tex)}}),e}}
