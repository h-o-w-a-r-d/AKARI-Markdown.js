/*!
 * AKARI-Markdown.js v1.0.0
 * (c) 2026 h-o-w-a-r-d
 * Released under the MIT License.
 * Repository: https://github.com/h-o-w-a-r-d/AKARI-Markdown.js
 * Documentation: https://h-o-w-a-r-d.github.io/AKARI-Markdown.js/README.md
 */import{marked as n}from"https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.esm.js";import c from"https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.es.min.js";import l from"https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.mjs";import a from"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/es/highlight.min.js";import h from"https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.esm.min.mjs";const m=["https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css","https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css","https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-dark.min.css"];export class AkariMarkdownElement extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.container=document.createElement("div"),this.container.classList.add("markdown-body");const r=document.createElement("style");r.textContent=`
            :host { display: block; overflow: hidden; } 
            .markdown-body { background: transparent; font-family: sans-serif; }
            /* \u4FEE\u6B63 Mermaid \u5728 Shadow DOM \u4E2D\u7684\u7F6E\u4E2D\u554F\u984C */
            .mermaid { display: flex; justify-content: center; margin: 1em 0; }
        `,this.shadowRoot.appendChild(r),this.shadowRoot.appendChild(this.container),this._injectShadowStyles(),this.options={theme:"default",throttleInterval:50,mermaidDebounce:800,hooks:{}},this.counter=0,this.mathMap=new Map,this.codeMap=new Map,this._renderTimer=null,this._mermaidTimer=null,this._latestMarkdown="",this._isRendering=!1,this._initLibraries()}connectedCallback(){!this.hasAttribute("no-render")&&this.textContent.trim().length>0&&this.render(this.textContent.trim())}set value(r){this.render(r)}get value(){return this._latestMarkdown}set config(r){this.options={...this.options,...r}}_injectShadowStyles(){m.forEach(r=>{const e=document.createElement("link");e.rel="stylesheet",e.href=r,this.shadowRoot.insertBefore(e,this.shadowRoot.firstChild)})}_initLibraries(){h.initialize({startOnLoad:!1,theme:this.options.theme,securityLevel:"loose"});const r=new n.Renderer;r.code=({text:e,lang:t})=>{if(t==="mermaid")return`<div class="mermaid">${e}</div>`;if(t&&a.getLanguage(t))try{return`<pre><code class="hljs language-${t}">${a.highlight(e,{language:t}).value}</code></pre>`}catch{}return`<pre><code class="hljs">${e}</code></pre>`},n.use({renderer:r})}async render(r,e=!1){if(this._latestMarkdown=r,e){this._clearTimers(),await this._performRender();return}this._isRendering||this._renderTimer||(this._renderTimer=setTimeout(async()=>{this._isRendering=!0,await this._performRender(),this._isRendering=!1,this._renderTimer=null},this.options.throttleInterval))}async _performRender(){let r=this._latestMarkdown||"";this.options.hooks.beforeParse&&(r=this.options.hooks.beforeParse(r)),this.mathMap.clear(),this.codeMap.clear(),this.counter=0;let e=this._protectCodeAndMath(r),t="";try{t=n.parse(e)}catch(s){console.error("AkariMarkdown Parse Error:",s),t='<p style="color:red">Parse Error</p>'}t=c.sanitize(t,{ADD_TAGS:["iframe"],ADD_ATTR:["target","class"]}),this.options.hooks.afterSanitize&&(t=this.options.hooks.afterSanitize(t)),t=this._restoreAndRenderMath(t),this.container.innerHTML=t,this._scheduleMermaidRender(),this.options.hooks.onRendered&&this.options.hooks.onRendered(this.container)}_scheduleMermaidRender(){this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._mermaidTimer=setTimeout(async()=>{const r=this.container.querySelectorAll(".mermaid");if(r.length!==0)try{await h.run({nodes:r,suppressErrors:!0})}catch{}},this.options.mermaidDebounce)}_clearTimers(){this._renderTimer&&clearTimeout(this._renderTimer),this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._renderTimer=null,this._mermaidTimer=null}_protectCodeAndMath(r){let e=r;return e=e.replace(/(\n|^)```[\s\S]*?```/g,t=>{const s=`CODEBLOCK${this.counter++}ENDCODE`;return this.codeMap.set(s,t),s}),e=e.replace(/(`+)(.*?)\1/g,t=>{const s=`CODEINLINE${this.counter++}ENDCODE`;return this.codeMap.set(s,t),s}),e=e.replace(/\\\$/g,t=>{const s=`ESCAPEDDOLLAR${this.counter++}END`;return this.codeMap.set(s,t),s}),e=e.replace(/(^|\n)\$\$([\s\S]+?)\$\$($|\n)/g,(t,s,i,d)=>{const o=`MATHBLOCK${this.counter++}ENDMATH`;return this.mathMap.set(o,{tex:i,display:!0}),s+o+d}),e=e.replace(/\$([^\n]+?)\$/g,(t,s)=>{if(/[\u4e00-\u9fa5]/.test(s)&&!s.includes("\\text"))return t;const i=`MATHINLINE${this.counter++}ENDMATH`;return this.mathMap.set(i,{tex:s,display:!1}),i}),this.codeMap.forEach((t,s)=>e=e.replace(s,t)),e}_restoreAndRenderMath(r){let e=r;return this.mathMap.forEach((t,s)=>{try{const i=l.renderToString(t.tex,{displayMode:t.display,throwOnError:!1,output:"html"});e=e.split(s).join(i)}catch{e=e.split(s).join(t.tex)}}),e}}customElements.define("akari-markdown",AkariMarkdownElement);
