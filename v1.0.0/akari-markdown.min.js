/*!
 * AKARI-Markdown.js v1.0.0
 * (c) 2026 h-o-w-a-r-d
 * Released under the MIT License.
 * Repository: https://github.com/h-o-w-a-r-d/AKARI-Markdown.js
 */import{marked as a}from"https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.esm.js";import c from"https://esm.sh/dompurify@3.0.9";import l from"https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.mjs";import h from"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/es/highlight.min.js";import n from"https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.esm.min.mjs";const m=["https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css","https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css","https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-dark.min.css"];export class AkariMarkdownElement extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.container=document.createElement("div"),this.container.classList.add("markdown-body");const i=document.createElement("style");i.textContent=':host{display:block;overflow:hidden;text-align:left}.markdown-body{background:transparent;font-family:sans-serif;line-height:1.6}.mermaid{display:flex;justify-content:center;margin:1em 0;background:transparent;overflow-x:auto}.mermaid>svg[id^="mermaid-error"]{border:1px solid red}',this.shadowRoot.appendChild(i),this.shadowRoot.appendChild(this.container),this._injectShadowStyles(),this.options={theme:"default",throttleInterval:50,mermaidDebounce:800,hooks:{}},this.counter=0,this.mathMap=new Map,this.codeMap=new Map,this._renderTimer=null,this._mermaidTimer=null,this._latestMarkdown="",this._isRendering=!1,this._initLibraries()}connectedCallback(){!this.hasAttribute("no-render")&&this.textContent.trim().length>0&&this.render(this.textContent.trim())}set value(i){this.render(i)}get value(){return this._latestMarkdown}set config(i){this.options={...this.options,...i},n.initialize({startOnLoad:!1,theme:this.options.theme,securityLevel:"loose"})}_injectShadowStyles(){m.forEach(i=>{const e=document.createElement("link");e.rel="stylesheet",e.href=i,this.shadowRoot.insertBefore(e,this.shadowRoot.firstChild)})}_initLibraries(){n.initialize({startOnLoad:!1,theme:this.options.theme,securityLevel:"loose"});const i={code(e,t){if(t==="mermaid")return`<div class="mermaid">${e}</div>`;if(t&&h.getLanguage(t))try{const r=h.highlight(e,{language:t}).value;return`<pre><code class="hljs language-${t}">${r}</code></pre>`}catch{}return`<pre><code class="hljs">${e}</code></pre>`}};a.use({renderer:i})}async render(i,e=!1){if(this._latestMarkdown=i||"",e){this._clearTimers(),await this._performRender();return}this._isRendering||this._renderTimer||(this._renderTimer=setTimeout(async()=>{this._isRendering=!0,await this._performRender(),this._isRendering=!1,this._renderTimer=null},this.options.throttleInterval))}async _performRender(){let i=this._latestMarkdown;try{this.options.hooks.beforeParse&&(i=this.options.hooks.beforeParse(i)),this.mathMap.clear(),this.codeMap.clear(),this.counter=0;let e=this._protectCodeAndMath(i),t=a.parse(e);t=c.sanitize(t,{ADD_TAGS:["iframe"],ADD_ATTR:["target","class"]}),this.options.hooks.afterSanitize&&(t=this.options.hooks.afterSanitize(t)),t=this._restoreAndRenderMath(t),this.container.innerHTML=t,this._scheduleMermaidRender(),this.options.hooks.onRendered&&this.options.hooks.onRendered(this.container)}catch(e){console.error("[AkariMarkdown] Render Error:",e),this.container.innerHTML=`<div style="color:red;border:1px solid red;padding:10px;">Render Error: ${e.message}</div>`}}_scheduleMermaidRender(){this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._mermaidTimer=setTimeout(async()=>{const i=this.container.querySelectorAll(".mermaid");for(const e of i){if(e.querySelector("svg"))continue;const t=e.textContent,r=`mermaid-${Math.random().toString(36).substr(2,9)}`;try{const{svg:s}=await n.render(r,t);e.innerHTML=s}catch{}}},this.options.mermaidDebounce)}_clearTimers(){this._renderTimer&&clearTimeout(this._renderTimer),this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._renderTimer=null,this._mermaidTimer=null}_protectCodeAndMath(i){if(!i)return"";let e=i;return e=e.replace(/(\n|^)```[\s\S]*?```/g,t=>{const r=`CODEBLOCK${this.counter++}ENDCODE`;return this.codeMap.set(r,t),r}),e=e.replace(/(`+)(.*?)\1/g,t=>{const r=`CODEINLINE${this.counter++}ENDCODE`;return this.codeMap.set(r,t),r}),e=e.replace(/\\\$/g,t=>{const r=`ESCAPEDDOLLAR${this.counter++}END`;return this.codeMap.set(r,t),r}),e=e.replace(/(^|\n)\$\$([\s\S]+?)\$\$($|\n)/g,(t,r,s,d)=>{const o=`MATHBLOCK${this.counter++}ENDMATH`;return this.mathMap.set(o,{tex:s,display:!0}),r+o+d}),e=e.replace(/\$([^\n]+?)\$/g,(t,r)=>{if(/[\u4e00-\u9fa5]/.test(r)&&!r.includes("\\text"))return t;const s=`MATHINLINE${this.counter++}ENDMATH`;return this.mathMap.set(s,{tex:r,display:!1}),s}),this.codeMap.forEach((t,r)=>e=e.replace(r,t)),e}_restoreAndRenderMath(i){let e=i;return this.mathMap.forEach((t,r)=>{try{const s=l.renderToString(t.tex,{displayMode:t.display,throwOnError:!1,output:"html"});e=e.split(r).join(s)}catch{e=e.split(r).join(t.tex)}}),e}}customElements.define("akari-markdown",AkariMarkdownElement);
