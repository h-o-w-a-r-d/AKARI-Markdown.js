/*!
 * AKARI-Markdown.js v1.0.0
 * (c) 2026 h-o-w-a-r-d
 * Released under the MIT License.
 * Repository: https://github.com/h-o-w-a-r-d/AKARI-Markdown.js
 */import{marked as d}from"https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.esm.js";import c from"https://esm.sh/dompurify@3.0.9";import l from"https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.mjs";import h from"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/es/highlight.min.js";import a from"https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.esm.min.mjs";const m=["https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css","https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css","https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-dark.min.css"];export class AkariMarkdownElement extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.container=document.createElement("div"),this.container.classList.add("markdown-body");const r=document.createElement("style");r.textContent=':host{display:block;overflow:hidden;text-align:left}.markdown-body{background:transparent;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;line-height:1.6}.mermaid{display:flex;justify-content:center;margin:1.5em 0;background:rgba(255,255,255,0.02);border-radius:8px;padding:10px;overflow-x:auto}.mermaid-source{font-family:Consolas,Monaco,"Andale Mono",monospace;font-size:0.85em;color:#8b949e;white-space:pre-wrap;text-align:left;width:100%;opacity:0.8}',this.shadowRoot.appendChild(r),this.shadowRoot.appendChild(this.container),this._injectShadowStyles(),this.options={theme:"dark",throttleInterval:50,mermaidDebounce:800,hooks:{}},this.counter=0,this.mathMap=new Map,this.codeMap=new Map,this._renderTimer=null,this._mermaidTimer=null,this._latestMarkdown="",this._isRendering=!1,this._initLibraries()}connectedCallback(){!this.hasAttribute("no-render")&&this.textContent.trim().length>0&&this.render(this.textContent.trim())}set value(r){this.render(r)}get value(){return this._latestMarkdown}set config(r){this.options={...this.options,...r},this._initMermaidConfig()}_injectShadowStyles(){m.forEach(r=>{const e=document.createElement("link");e.rel="stylesheet",e.href=r,this.shadowRoot.insertBefore(e,this.shadowRoot.firstChild)})}_initLibraries(){this._initMermaidConfig();const r={code(e,t){if(t==="mermaid")return`<div class="mermaid">${e}</div>`;if(t&&h.getLanguage(t))try{const i=h.highlight(e,{language:t}).value;return`<pre><code class="hljs language-${t}">${i}</code></pre>`}catch{}return`<pre><code class="hljs">${e}</code></pre>`}};d.use({renderer:r})}_initMermaidConfig(){a.initialize({startOnLoad:!1,theme:this.options.theme,securityLevel:"loose",suppressErrorRendering:!0}),a.parseError=function(r,e){}}async render(r,e=!1){if(this._latestMarkdown=r||"",e){this._clearTimers(),await this._performRender();return}this._isRendering||this._renderTimer||(this._renderTimer=setTimeout(async()=>{this._isRendering=!0,await this._performRender(),this._isRendering=!1,this._renderTimer=null},this.options.throttleInterval))}async _performRender(){let r=this._latestMarkdown;try{this.options.hooks.beforeParse&&(r=this.options.hooks.beforeParse(r)),this.mathMap.clear(),this.codeMap.clear(),this.counter=0;let e=this._protectCodeAndMath(r),t=d.parse(e);t=c.sanitize(t,{ADD_TAGS:["iframe"],ADD_ATTR:["target","class"]}),this.options.hooks.afterSanitize&&(t=this.options.hooks.afterSanitize(t)),t=this._restoreAndRenderMath(t),this.container.innerHTML=t,this._scheduleMermaidRender(),this.options.hooks.onRendered&&this.options.hooks.onRendered(this.container)}catch(e){console.error("[AkariMarkdown] Render Error:",e),this.container.innerHTML=`<div style="color:red;border:1px solid red;padding:10px;">Render Error: ${e.message}</div>`}}_scheduleMermaidRender(){this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._mermaidTimer=setTimeout(async()=>{const r=this.container.querySelectorAll(".mermaid");for(const e of r){if(e.querySelector("svg"))continue;const t=e.textContent,i=`mermaid-${Math.random().toString(36).substr(2,9)}`;try{const{svg:s}=await a.render(i,t);e.innerHTML=s}catch{e.innerHTML=`<div class="mermaid-source">${this._escapeHtml(t)}</div>`;const o=document.getElementById("d"+i);o&&o.remove();const n=document.getElementById(i);n&&n!==e&&n.remove()}}},this.options.mermaidDebounce)}_clearTimers(){this._renderTimer&&clearTimeout(this._renderTimer),this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._renderTimer=null,this._mermaidTimer=null}_protectCodeAndMath(r){if(!r)return"";let e=r;return e=e.replace(/(\n|^)```[\s\S]*?```/g,t=>{const i=`CODEBLOCK${this.counter++}ENDCODE`;return this.codeMap.set(i,t),i}),e=e.replace(/(`+)(.*?)\1/g,t=>{const i=`CODEINLINE${this.counter++}ENDCODE`;return this.codeMap.set(i,t),i}),e=e.replace(/\\\$/g,t=>{const i=`ESCAPEDDOLLAR${this.counter++}END`;return this.codeMap.set(i,t),i}),e=e.replace(/(^|\n)\$\$([\s\S]+?)\$\$($|\n)/g,(t,i,s,o)=>{const n=`MATHBLOCK${this.counter++}ENDMATH`;return this.mathMap.set(n,{tex:s,display:!0}),i+n+o}),e=e.replace(/\$([^\n]+?)\$/g,(t,i)=>{if(/[\u4e00-\u9fa5]/.test(i)&&!i.includes("\\text"))return t;const s=`MATHINLINE${this.counter++}ENDMATH`;return this.mathMap.set(s,{tex:i,display:!1}),s}),this.codeMap.forEach((t,i)=>e=e.replace(i,t)),e}_restoreAndRenderMath(r){let e=r;return this.mathMap.forEach((t,i)=>{try{const s=l.renderToString(t.tex,{displayMode:t.display,throwOnError:!1,output:"html"});e=e.split(i).join(s)}catch{e=e.split(i).join(t.tex)}}),e}_escapeHtml(r){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return r.replace(/[&<>"']/g,t=>e[t])}}customElements.define("akari-markdown",AkariMarkdownElement);
