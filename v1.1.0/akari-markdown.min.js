/*!
 * AKARI-Markdown.js v1.1.0 (Fix Mermaid Rendering)
 * (c) 2026 h-o-w-a-r-d
 * Released under the MIT License.
 * Repository: https://github.com/h-o-w-a-r-d/AKARI-Markdown.js
 */import{marked as l}from"https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.esm.js";import u from"https://esm.sh/dompurify@3.0.9";import f from"https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.mjs";import m from"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/es/highlight.min.js";import c from"https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.esm.min.mjs";const g=["https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css","https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css","https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-dark.min.css"];export class AkariMarkdownElement extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.container=document.createElement("div"),this.container.classList.add("markdown-body");const i=document.createElement("style");i.textContent=`:host{display:block;overflow:hidden;text-align:left;}.markdown-body{background:transparent;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;line-height:1.6;}.mermaid{display:flex;justify-content:center;margin:1.5em 0;background:rgba(255,255,255,0.02);border-radius:8px;padding:10px;overflow-x:auto;transition:opacity 0.3s ease;}.mermaid-source,.mermaid-streaming{font-family:Consolas,Monaco,'Andale Mono',monospace;font-size:0.85em;color:#8b949e;white-space:pre-wrap;text-align:left;width:100%;opacity:0.8;border-left:2px solid #30363d;padding-left:10px;}.mermaid-error-msg{color:#ff6b6b;font-size:0.8em;padding:8px;background:rgba(255,0,0,0.1);border-radius:4px;margin-bottom:5px;white-space:pre-wrap;font-family:monospace;}.mermaid-streaming::after{content:' \u258B';animation:blink 1s infinite;}@keyframes blink{50%{opacity:0;}}`,this.shadowRoot.appendChild(i),this.shadowRoot.appendChild(this.container),this._injectShadowStyles(),this.options={theme:"dark",throttleInterval:30,mermaidDebounce:300,hooks:{}},this.counter=0,this.mathMap=new Map,this.codeMap=new Map,this._renderTimer=null,this._mermaidTimer=null,this._latestMarkdown="",this._isRendering=!1,this._isMermaidWorking=!1,this._initLibraries()}connectedCallback(){!this.hasAttribute("no-render")&&this.textContent.trim().length>0&&this.render(this.textContent.trim())}set value(i){this.render(i)}get value(){return this._latestMarkdown}set config(i){this.options={...this.options,...i},this._initMermaidConfig()}_injectShadowStyles(){g.forEach(i=>{const e=document.createElement("link");e.rel="stylesheet",e.href=i,this.shadowRoot.insertBefore(e,this.shadowRoot.firstChild)})}_initLibraries(){this._initMermaidConfig();const i={code:(e,r)=>{if(r=r||"",r==="mermaid"){const t=this._decodeHtml(e);return this._checkMermaidIntegrity(t)?`<div class="mermaid" data-code="${this._hashCode(t)}">${this._escapeHtml(t)}</div>`:`<div class="mermaid-streaming">${this._escapeHtml(t)}</div>`}if(r&&m.getLanguage(r))try{const t=m.highlight(e,{language:r}).value;return`<pre><code class="hljs language-${r}">${t}</code></pre>`}catch{}return`<pre><code class="hljs">${this._escapeHtml(e)}</code></pre>`}};l.use({renderer:i})}_initMermaidConfig(){c.initialize({startOnLoad:!1,theme:this.options.theme,securityLevel:"loose",suppressErrorRendering:!0}),c.parseError=function(i,e){}}_checkMermaidIntegrity(i){if(!this._latestMarkdown)return!1;const e=i.trim();if(e.length===0)return!1;const r=e.slice(-Math.min(e.length,50)),t=this._latestMarkdown.lastIndexOf(r);if(t===-1)return!1;const s=this._latestMarkdown.slice(t+r.length);return/^\s*```/.test(s)}_decodeHtml(i){const e=document.createElement("textarea");return e.innerHTML=i,e.value}async render(i,e=!1){if(this._latestMarkdown=i||"",e){this._clearTimers(),await this._performRender(!0);return}this._isRendering||this._renderTimer||(this._renderTimer=setTimeout(async()=>{this._isRendering=!0,await this._performRender(),this._isRendering=!1,this._renderTimer=null},this.options.throttleInterval))}async _performRender(i=!1){let e=this._latestMarkdown;try{this.options.hooks.beforeParse&&(e=this.options.hooks.beforeParse(e)),this.mathMap.clear(),this.codeMap.clear(),this.counter=0;let r=this._protectCodeAndMath(e),t=l.parse(r);t=u.sanitize(t,{ADD_TAGS:["iframe"],ADD_ATTR:["target","class","data-code","data-rendered"]}),this.options.hooks.afterSanitize&&(t=this.options.hooks.afterSanitize(t)),t=this._restoreAndRenderMath(t),i?this.container.innerHTML=t:this._updateDOM(this.container,t),this._scheduleMermaidRender(),this.options.hooks.onRendered&&this.options.hooks.onRendered(this.container)}catch(r){console.error("[AkariMarkdown] Render Error:",r)}}_updateDOM(i,e){const r=document.createElement("div");r.innerHTML=e;const t=Array.from(r.childNodes),s=Array.from(i.childNodes),d=Math.max(t.length,s.length);for(let a=0;a<d;a++){const n=t[a],o=s[a];if(!o){i.appendChild(n.cloneNode(!0));continue}if(!n){o.remove();continue}if(n.nodeType!==o.nodeType||n.tagName!==o.tagName){i.replaceChild(n.cloneNode(!0),o);continue}if(n.nodeType===Node.TEXT_NODE){n.textContent!==o.textContent&&(o.textContent=n.textContent);continue}if(n.nodeType===Node.ELEMENT_NODE){if(n.classList.contains("mermaid")&&o.classList.contains("mermaid")&&o.dataset.rendered==="true"){const h=n.getAttribute("data-code"),p=o.getAttribute("data-code");if(h&&h===p)continue}n.outerHTML!==o.outerHTML&&(n.className,o.className,i.replaceChild(n.cloneNode(!0),o))}}}_scheduleMermaidRender(){this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._mermaidTimer=setTimeout(async()=>{if(this._isMermaidWorking)return;const i=this.container.querySelectorAll(".mermaid");if(i.length!==0){this._isMermaidWorking=!0;for(const e of i){if(e.querySelector("svg"))continue;const r=this._decodeHtml(e.textContent);if(!r.trim())continue;const t=`mermaid-${Math.random().toString(36).substr(2,9)}`;try{const{svg:s}=await c.render(t,r);e.innerHTML=s,e.dataset.rendered="true",e.classList.remove("mermaid-error")}catch(s){console.warn("[AkariMarkdown] Mermaid Error:",s),e.innerHTML=`
                        <div class="mermaid-error-msg">\u26A0\uFE0F Mermaid Error:
${this._escapeHtml(s.message)}</div>
                        <div class="mermaid-source">${this._escapeHtml(r)}</div>
                    `,e.classList.add("mermaid-error");const d=document.getElementById("d"+t)||document.getElementById(t);d&&d.remove()}}this._isMermaidWorking=!1}},this.options.mermaidDebounce)}_clearTimers(){this._renderTimer&&clearTimeout(this._renderTimer),this._mermaidTimer&&clearTimeout(this._mermaidTimer),this._renderTimer=null,this._mermaidTimer=null}_protectCodeAndMath(i){if(!i)return"";let e=i;return e=e.replace(/(\n|^)```[\s\S]*?```/g,r=>{const t=`CODEBLOCK${this.counter++}ENDCODE`;return this.codeMap.set(t,r),t}),e=e.replace(/(`+)(.*?)\1/g,r=>{const t=`CODEINLINE${this.counter++}ENDCODE`;return this.codeMap.set(t,r),t}),e=e.replace(/\\\$/g,r=>{const t=`ESCAPEDDOLLAR${this.counter++}END`;return this.codeMap.set(t,r),t}),e=e.replace(/(^|\n)\$\$([\s\S]+?)\$\$($|\n)/g,(r,t,s,d)=>{const a=`MATHBLOCK${this.counter++}ENDMATH`;return this.mathMap.set(a,{tex:s,display:!0}),t+a+d}),e=e.replace(/\$([^\n]+?)\$/g,(r,t)=>{if(/[\u4e00-\u9fa5]/.test(t)&&!t.includes("\\text"))return r;const s=`MATHINLINE${this.counter++}ENDMATH`;return this.mathMap.set(s,{tex:t,display:!1}),s}),this.codeMap.forEach((r,t)=>e=e.replace(t,r)),e}_restoreAndRenderMath(i){let e=i;return this.mathMap.forEach((r,t)=>{try{const s=f.renderToString(r.tex,{displayMode:r.display,throwOnError:!1,output:"html"});e=e.split(t).join(s)}catch{e=e.split(t).join(r.tex)}}),e}_escapeHtml(i){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return i.replace(/[&<>"']/g,r=>e[r])}_hashCode(i){let e=0;for(let r=0;r<i.length;r++){const t=i.charCodeAt(r);e=(e<<5)-e+t,e=e&e}return e.toString(36)}}customElements.define("akari-markdown",AkariMarkdownElement);
